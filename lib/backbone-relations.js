// Generated by CoffeeScript 1.7.1
var __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
  __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

(function(root, factory) {
  if ((typeof define !== "undefined" && define !== null ? define.amd : void 0)) {
    return define(['exports', 'backbone', 'underscore'], factory);
  } else if ((typeof exports !== "undefined" && exports !== null)) {
    return factory(exports, require('backbone'), require('underscore'));
  } else {
    return factory(root, root.Backbone, root._);
  }
})(this, function(exports, Backbone, _) {
  var RelationalModel;
  RelationalModel = (function(_super) {
    var _base;

    __extends(RelationalModel, _super);

    function RelationalModel() {
      return RelationalModel.__super__.constructor.apply(this, arguments);
    }

    if ((_base = RelationalModel.prototype).models == null) {
      _base.models = {};
    }

    RelationalModel.registerModel = function(name) {
      this.prototype.__name__ = name;
      return this.prototype.models[name] = this;
    };

    RelationalModel._relational = {
      define: function(name, model, plural, options) {
        if (this._associations == null) {
          this._associations = {};
        }
        return this._associations[name] = {
          name: name,
          plural: plural,
          model: model,
          embeds: options.embeds,
          embedded: options.embedded,
          through: options.through,
          links: options.links,
          source: options.source,
          inverse: options.inverse
        };
      }
    };

    RelationalModel.many = function(name, model, options) {
      this._relational.define.call(this, name, model, true, options);
      this.prototype.mutators[name] = function() {
        var Collection, definition, inverse, links, _ref, _ref1, _ref2, _ref3;
        if (this["_" + name]) {
          return this["_" + name];
        }
        definition = this.constructor._associations[name];
        model = this.constructor.prototype.models[definition.model];
        Collection = Backbone.Collection.extend({
          model: model
        });
        switch (false) {
          case !definition.embeds:
            this["_" + name] = new Collection((_ref = this.get('linked')) != null ? _ref[name] : void 0);
            inverse = definition.inverse;
            if (model._associations[inverse]) {
              this["_" + name].each(function(member) {
                return member["_" + inverse] = this;
              }, this);
            } else {
              throw "" + model.prototype.__name__ + " missing inverse association '" + inverse + "'";
            }
            break;
          case !definition.through:
            if (this.constructor._associations[definition.through].plural) {
              this["_" + name] = new Collection;
              this.get(definition.through).each(function(member) {
                var through, _ref1;
                if (through = member.get((_ref1 = definition.source) != null ? _ref1 : name)) {
                  this["_" + name].add(through.models);
                  if (!definition.links) {
                    this.listenTo(through, 'add', function(model, collection, options) {
                      return this["_" + name].add(model);
                    });
                    return this.listenTo(through, 'remove', function(model, collection, options) {
                      var exists;
                      exists = this.get(definition.through).find(function(member) {
                        var _ref2, _through;
                        _through = member.get((_ref2 = definition.source) != null ? _ref2 : name);
                        return _through.get(model.id);
                      });
                      if (!exists) {
                        return this["_" + name].remove(model);
                      }
                    });
                  }
                }
              }, this);
            } else {
              this["_" + name] = (_ref1 = this.get(definition.through)) != null ? _ref1.get((_ref2 = definition.source) != null ? _ref2 : name) : void 0;
            }
            if (definition.links && (links = (_ref3 = this.get('links')) != null ? _ref3[name] : void 0)) {
              this["_" + name].each(function(member) {
                var _ref4;
                if (_ref4 = member.id, __indexOf.call(links, _ref4) < 0) {
                  return this["_" + name].remove(member);
                }
              }, this);
            }
            break;
          default:
            throw "many " + name + " must be #embeds or #through";
        }
        return this["_" + name];
      };
      return this._associations[name];
    };

    RelationalModel.one = function(name, model, options) {
      this._relational.define.call(this, name, model, false, options);
      this.prototype.mutators[name] = function() {
        var data, definition;
        if (this["_" + name]) {
          return this["_" + name];
        }
        definition = this.constructor._associations[name];
        return data = (function() {
          switch (false) {
            case !definition.embedded:
              throw "" + this + " must be instantiated from " + name + ", eg " + name + ".get('" + definition.inverse + "')";
              break;
            default:
              throw "" + this.__name__ + " one " + name + " must be #embeds";
          }
        }).call(this);
      };
      return this._associations[name];
    };

    return RelationalModel;

  })(Backbone.Model);
  exports.RelationalModel = RelationalModel;
});
